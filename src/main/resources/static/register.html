<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>≈ûagird Qeydiyyatƒ±</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg1:#0ea5e9;
            --bg2:#22c55e;
            --bg3:#a78bfa;

            --glass: rgba(255,255,255,.18);
            --glass2: rgba(255,255,255,.12);

            --text:#0f172a;
            --muted:#475569;

            --border: rgba(255,255,255,.28);
            --shadow: 0 18px 60px rgba(2,6,23,.18);
            --shadow2: 0 10px 30px rgba(2,6,23,.12);

            --radius: 22px;
        }

        *{ margin:0; padding:0; box-sizing:border-box; }

        body{
            font-family:'Poppins', sans-serif;
            color:var(--text);
            min-height:100vh;
            overflow-x:hidden;

            background:
                    radial-gradient(900px 600px at 10% 10%, rgba(34,197,94,.45), transparent 60%),
                    radial-gradient(900px 600px at 90% 20%, rgba(14,165,233,.40), transparent 55%),
                    radial-gradient(900px 700px at 30% 90%, rgba(167,139,250,.35), transparent 55%),
                    linear-gradient(180deg, #f8fafc, #ecfeff);

            padding-top: 90px;
            display:flex;
            flex-direction:column;
            align-items:center;
        }

        /* Loader */
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Floating blobs */
        .blob{
            position: fixed;
            width: 460px; height: 460px;
            border-radius: 50%;
            filter: blur(48px);
            opacity: .22;
            z-index:0;
            animation: float 10s ease-in-out infinite;
            pointer-events:none;
        }
        .blob.b1{ left:-160px; top:120px; background: linear-gradient(135deg, var(--bg2), var(--bg1)); }
        .blob.b2{ right:-180px; top:140px; background: linear-gradient(135deg, var(--bg1), var(--bg3)); animation-delay: -2s; }
        .blob.b3{ left: 22%; bottom:-240px; background: linear-gradient(135deg, var(--bg3), var(--bg2)); animation-delay: -4s; }
        @keyframes float{
            0%,100%{ transform: translateY(0) translateX(0) scale(1); }
            50%{ transform: translateY(-22px) translateX(14px) scale(1.04); }
        }

        /* Header */
        header{
            position: fixed;
            top: 0; left: 0;
            width: 100%;
            padding: 14px 20px;
            z-index: 60;
            display:flex;
            align-items:center;
            justify-content:space-between;

            background: rgba(255,255,255,.20);
            backdrop-filter: blur(22px);
            border-bottom: 1px solid rgba(255,255,255,.22);
            box-shadow: 0 18px 45px rgba(2,6,23,.10);
        }

        header:before{
            content:"";
            position:absolute;
            left:0; right:0; top:0;
            height: 3px;
            background: linear-gradient(90deg, var(--bg2), var(--bg1), var(--bg3));
            opacity: .9;
        }

        .brand{
            display:flex;
            align-items:center;
            gap:12px;
            user-select:none;
            position:relative;
            z-index:1;
        }

        .logo{
            width: 44px; height:44px;
            border-radius: 16px;
            background: linear-gradient(135deg, var(--bg2), var(--bg1));
            box-shadow: 0 18px 34px rgba(34,197,94,.22);
            display:grid;
            place-items:center;
            color:white;
            font-weight:900;
            letter-spacing:-.6px;
            position:relative;
            overflow:hidden;
        }
        .logo:after{
            content:"";
            position:absolute;
            inset:-30%;
            background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.45), transparent 55%);
            transform: rotate(25deg);
            opacity:.9;
        }

        header h1{
            font-size: 1.06rem;
            font-weight: 800;
            line-height: 1.1;
            letter-spacing: -.2px;
        }
        header h1 span{
            display:block;
            font-size:.78rem;
            font-weight:600;
            color: rgba(71,85,105,.85);
            margin-top:4px;
        }

        nav{
            display:flex;
            gap:10px;
            flex-wrap:wrap;
            justify-content:flex-end;
            position:relative;
            z-index:1;
        }
        nav a{
            text-decoration:none;
            color: rgba(15,23,42,.92);
            font-weight:800;
            font-size:.92rem;
            padding: 10px 14px;
            border-radius: 999px;

            background: rgba(255,255,255,.38);
            border: 1px solid rgba(255,255,255,.28);
            transition: .18s ease;
            display:flex;
            align-items:center;
            gap:8px;
        }
        nav a:hover{
            transform: translateY(-1px);
            background: rgba(255,255,255,.60);
            box-shadow: 0 12px 24px rgba(2,6,23,.10);
        }
        nav a.active{
            background: linear-gradient(135deg, rgba(34,197,94,.22), rgba(14,165,233,.22));
            border-color: rgba(34,197,94,.35);
        }

        main{
            width: 100%;
            max-width: 1120px;
            padding: 0 16px 28px;
            position: relative;
            z-index: 2;
        }

        .grid{
            display:grid;
            grid-template-columns: 1.1fr .9fr;
            gap: 18px;
            align-items:start;
        }
        @media (max-width: 980px){
            .grid{ grid-template-columns: 1fr; }
        }

        /* Panels */
        .panel{
            border-radius: var(--radius);
            background: rgba(255,255,255,.56);
            border: 1px solid rgba(255,255,255,.38);
            backdrop-filter: blur(18px);
            box-shadow: var(--shadow);
            overflow:hidden;
            transform: translateZ(0);
        }
        .panel:hover{
            box-shadow: 0 22px 72px rgba(2,6,23,.18);
        }

        .panel-header{
            padding: 18px 18px 14px;
            border-bottom: 1px solid rgba(15,23,42,.06);
            background:
                    linear-gradient(135deg, rgba(34,197,94,.14), rgba(14,165,233,.12));
        }

        .panel-title{
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
        }

        .panel-title h2{
            font-size: 1.28rem;
            font-weight: 900;
            letter-spacing: -.5px;
        }

        .chip{
            padding: 8px 10px;
            border-radius: 999px;
            font-size: .78rem;
            font-weight: 900;
            color: rgba(15,23,42,.85);
            background: rgba(255,255,255,.60);
            border: 1px solid rgba(255,255,255,.35);
            box-shadow: 0 10px 20px rgba(2,6,23,.08);
        }

        .panel-sub{
            margin-top: 8px;
            color: rgba(71,85,105,.92);
            font-size: .92rem;
            line-height: 1.35;
            font-weight: 600;
        }

        form{ padding: 18px; }

        .fields{
            display:grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        @media (max-width: 640px){
            .fields{ grid-template-columns: 1fr; }
        }

        .field{
            display:flex;
            flex-direction:column;
            gap: 8px;
        }
        .field label{
            font-size: .86rem;
            font-weight: 900;
            color: rgba(15,23,42,.86);
        }

        .control{ position: relative; }

        .icon{
            position:absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            opacity: .78;
            pointer-events:none;
        }

        input, select{
            width:100%;
            padding: 13px 14px 13px 38px;
            border-radius: 16px;
            border: 1px solid rgba(148,163,184,.35);
            background: rgba(255,255,255,.75);
            box-shadow: 0 10px 24px rgba(2,6,23,.06);
            font-size: .95rem;
            outline:none;
            transition: .18s ease;
        }

        input:focus, select:focus{
            border-color: rgba(34,197,94,.58);
            box-shadow: 0 0 0 6px rgba(34,197,94,.14), 0 14px 28px rgba(2,6,23,.10);
            transform: translateY(-1px);
        }

        /* BSP block */
        .bsp{
            display:flex;
            align-items:center;
            gap:10px;
            margin-top: 12px;
            padding: 12px 14px;
            border-radius: 16px;
            background: rgba(255,255,255,.58);
            border: 1px dashed rgba(34,197,94,.40);
        }
        .bsp input{
            width: 18px; height:18px;
            padding:0;
            border-radius: 6px;
            box-shadow:none;
            transform:none !important;
        }
        .bsp small{
            color: rgba(71,85,105,.95);
            font-weight: 700;
        }

        /* Actions */
        .actions{
            margin-top: 14px;
            display:flex;
            gap: 10px;
            align-items:center;
        }

        button{
            width:100%;
            padding: 13px 14px;
            border: none;
            border-radius: 16px;
            cursor:pointer;
            color:white;
            font-weight: 900;
            letter-spacing: .2px;
            font-size: .98rem;
            transition:.18s ease;
            background: linear-gradient(135deg, var(--bg2), var(--bg1));
            box-shadow: 0 16px 36px rgba(34,197,94,.22);
        }
        button:hover{
            transform: translateY(-1px);
            box-shadow: 0 18px 38px rgba(14,165,233,.22);
        }
        button:disabled{
            opacity:.7;
            cursor:not-allowed;
            transform:none;
        }

        /* Result toast */
        #result{
            margin-top: 14px;
            padding: 12px 14px;
            border-radius: 16px;
            font-weight: 900;
            display:none;
            align-items:center;
            justify-content:space-between;
            gap: 10px;
            border: 1px solid transparent;
            animation: pop .25s ease;
        }
        @keyframes pop{
            from{ opacity:0; transform: translateY(10px); }
            to{ opacity:1; transform: translateY(0); }
        }
        #result.success{
            display:flex;
            background: rgba(34,197,94,.12);
            border-color: rgba(34,197,94,.22);
            color: #065f46;
        }
        #result.error{
            display:flex;
            background: rgba(239,68,68,.10);
            border-color: rgba(239,68,68,.22);
            color: #991b1b;
        }
        #result .x{
            width: 34px; height:34px;
            border-radius: 12px;
            display:grid;
            place-items:center;
            background: rgba(255,255,255,.62);
            border: 1px solid rgba(255,255,255,.35);
            cursor:pointer;
            user-select:none;
        }

        .helper{
            margin-top: 10px;
            font-size: .85rem;
            color: rgba(71,85,105,.88);
            line-height: 1.35;
            font-weight: 700;
        }

        /* Ticket */
        .ticket-wrap{ padding: 18px; display:none; }
        .ticket{
            border-radius: var(--radius);
            border: 1px solid rgba(255,255,255,.30);
            background: rgba(255,255,255,.65);
            backdrop-filter: blur(18px);
            box-shadow: var(--shadow2);
            overflow:hidden;
            animation: pop .28s ease;
        }

        .ticket-top{
            padding: 16px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            gap: 12px;
            background: linear-gradient(135deg, rgba(34,197,94,.16), rgba(14,165,233,.14));
            border-bottom: 1px solid rgba(15,23,42,.06);
        }
        .ticket-top .left{ display:flex; align-items:center; gap:12px; }

        .qr-mini{
            width: 66px; height:66px;
            border-radius: 18px;
            border: 1px solid rgba(255,255,255,.35);
            box-shadow: 0 12px 22px rgba(2,6,23,.10);
            object-fit:cover;
            background:white;
        }
        .ticket-top h3{
            margin:0;
            font-size: 1.06rem;
            font-weight: 900;
            letter-spacing: -.2px;
        }
        .ticket-top p{
            margin-top: 4px;
            font-size: .86rem;
            color: rgba(71,85,105,.92);
            font-weight: 700;
        }

        .ticket-body{
            padding: 16px;
            display:grid;
            gap: 10px;
        }

        .kv{
            display:flex;
            justify-content:space-between;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 16px;
            background: rgba(255,255,255,.55);
            border: 1px solid rgba(148,163,184,.20);
            font-size: .95rem;
        }
        .kv b{ color: rgba(15,23,42,.92); font-weight: 900; }
        .kv span{ color: rgba(71,85,105,.95); font-weight: 900; text-align:right; }

        .ticket-actions{
            padding: 14px 16px 16px;
            border-top: 1px solid rgba(15,23,42,.06);
            display:flex;
            gap: 10px;
        }
        .btn-secondary{
            background: linear-gradient(135deg, #16f1f9, var(--bg2));
            box-shadow: 0 16px 36px rgba(249,115,22,.18);
        }

        .empty-note{
            padding:18px;
            color: rgba(71,85,105,.90);
            font-weight: 800;
        }

        /* =========================
           CONFIRM MODAL (YENI)
           ========================= */
        .overlay{
            position: fixed;
            inset: 0;
            background: rgba(2,6,23,.45);
            backdrop-filter: blur(8px);
            z-index: 9999;
            display:flex;
            align-items:center;
            justify-content:center;
            padding: 16px;
        }

        .confirmModal{
            width: min(520px, 100%);
            background: rgba(255,255,255,.78);
            border: 1px solid rgba(255,255,255,.38);
            border-radius: 22px;
            box-shadow: 0 22px 72px rgba(2,6,23,.25);
            padding: 18px;
            animation: pop .2s ease;
        }

        .confirmModal h3{
            margin:0;
            font-size: 1.12rem;
            font-weight: 900;
        }

        .confirmList{
            margin-top: 12px;
            display:grid;
            gap: 10px;
        }

        .confirmItem{
            display:flex;
            justify-content:space-between;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 16px;
            background: rgba(255,255,255,.62);
            border: 1px solid rgba(148,163,184,.22);
            font-weight: 900;
        }

        .confirmItem span:first-child{
            color: rgba(71,85,105,.95);
        }

        .confirmItem span:last-child{
            color: rgba(15,23,42,.92);
            text-align:right;
        }

        .confirmActions{
            display:flex;
            gap: 10px;
            margin-top: 14px;
        }

        .confirmActions button{
            width: 100%;
            border-radius: 16px;
            padding: 12px 14px;
            font-weight: 900;
        }

        .btnNo{
            background: linear-gradient(135deg, #ef4444, #f97316) !important;
            box-shadow: 0 16px 36px rgba(239,68,68,.20) !important;
        }

        .btnYes{
            background: linear-gradient(135deg, var(--bg2), var(--bg1)) !important;
        }
    </style>
</head>

<body>
<div class="blob b1"></div>
<div class="blob b2"></div>
<div class="blob b3"></div>

<header>
    <div class="brand">
        <div class="logo">BSP</div>
        <h1>
            ƒ∞mtahanlarƒ±n ƒ∞dar…ô Paneli
            <span>≈ûagird qeydiyyatƒ± v…ô bilet √ßapƒ±</span>
        </h1>
    </div>
    <nav>
        <a href="index.html">üè† Ana s…ôhif…ô</a>
        <a href="room.html">üè´ Otaqlar</a>
        <a href="room-detailed.html">üß© Sistem</a>
        <a href="students.html" class="active">üë®‚Äçüéì T…ôl…ôb…ôl…ôr</a>
    </nav>
</header>

<main>
    <div class="grid">
        <!-- LEFT -->
        <section class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <h2>≈ûagird Qeydiyyatƒ±</h2>
                    <div class="chip">Bilet</div>
                </div>
                <div class="panel-sub">
                    M…ôlumatlarƒ± doldurun v…ô qeydiyyatƒ± tamamlayƒ±n.
                </div>
            </div>

            <form id="studentForm">
                <div class="fields">
                    <div class="field">
                        <label>Ad</label>
                        <div class="control">
                            <span class="icon">üë§</span>
                            <input type="text" name="name" placeholder="M…ôs: Aƒüa" required>
                        </div>
                    </div>

                    <div class="field">
                        <label>Soyad</label>
                        <div class="control">
                            <span class="icon">ü™™</span>
                            <input type="text" name="surname" placeholder="M…ôs: ∆èliyev" required>
                        </div>
                    </div>

                    <div class="field">
                        <label>Ata adƒ±</label>
                        <div class="control">
                            <span class="icon">üßæ</span>
                            <input type="text" name="fatherName" placeholder="M…ôs: B…ôhlul" required>
                        </div>
                    </div>

                    <div class="field">
                        <label>Telefon</label>
                        <div class="control">
                            <span class="icon">üìû</span>
                            <input type="text" name="phone" placeholder="M…ôs: 070 777 00 00" required>
                        </div>
                    </div>

                    <div class="field">
                        <label>Sinif</label>
                        <div class="control">
                            <span class="icon">üéì</span>
                            <select id="gradeSelect" name="grade" required onchange="updateExamTime()">
                                <option value="">Sinif se√ßin</option>
                                <option value="9">9</option>
                                <option value="10">10</option>
                                <option value="11">11</option>
                                <option value="12">12</option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <label>Qrup</label>
                        <div class="control">
                            <span class="icon">üë•</span>
                            <select id="studentType" name="studentType" required onchange="updatePaymentAmount()">
                                <option value="">Se√ßin...</option>
                                <option value="BSP">BSP t…ôl…ôb…ôsi</option>
                                <option value="Other">K…ônar t…ôl…ôb…ô</option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <label>√ñd…ôni≈ü (AZN)</label>
                        <div class="control">
                            <span class="icon">üí≥</span>
                            <input type="number" id="paymentAmount" name="paymentAmount" step="0.01" readonly required>
                        </div>
                    </div>

                    <div class="field">
                        <label>ƒ∞mtahan</label>
                        <div class="control">
                            <span class="icon">üìù</span>
                            <select id="examSelect" name="examId" required onchange="updateSelectedExam(); updateExamTime();">
                                <option value="">ƒ∞mtahan se√ßin</option>
                                <option value="6">Riyaziyyat buraxƒ±lƒ±≈ü sƒ±naq 5</option>
                                <option value="7">Fizika m√∂vzu sƒ±naƒüƒ± 2</option>
                            </select>
                        </div>
                    </div>

                    <div class="field">
                        <label>ƒ∞mtahan vaxtƒ±</label>
                        <div class="control">
                            <span class="icon">‚è∞</span>
                            <select id="examTime" name="examTime" required>
                                <option value="10:00">10:00</option>
                                <option value="11:30">11:30</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="bsp">
                    <input type="checkbox" id="bspStudent" name="bspStudent"
                           style="pointer-events:none; opacity:.85; cursor:not-allowed;">
                    <div>
                        <div style="font-weight:900;">BSP LearnUp t…ôl…ôb…ôsiy…ôm</div>
                    </div>
                </div>

                <div class="actions">
                    <button type="submit">‚úÖ Qeydiyyatƒ± tamamla</button>
                </div>

                <div id="result">
                    <div id="resultText">Mesaj</div>
                    <div class="x" onclick="hideResult()">‚úï</div>
                </div>


            </form>
        </section>

        <!-- RIGHT -->
        <section class="panel">
            <div class="panel-header">
                <div class="panel-title">
                    <h2>Bilet</h2>
                    <div class="chip">√áap √º√ß√ºn hazƒ±r</div>
                </div>
                <div class="panel-sub">
                    ...
                </div>
            </div>

            <div class="ticket-wrap" id="cardContainer">
                <div class="ticket" id="printCard">
                    <div class="ticket-top">
                        <div class="left">
                            <img class="qr-mini" src="mathbsp-az-qr-code.png" alt="QR Kod">
                            <div>
                                <h3 id="cardExamName">ƒ∞mtahan</h3>
                                <p><span id="cardDate"></span> ‚Ä¢ <span id="cardTime"></span></p>
                            </div>
                        </div>
                        <div class="chip" style="font-size:.80rem;">BSP</div>
                    </div>

                    <div class="ticket-body">
                        <div class="kv"><b>Ad Soyad Ata adƒ±</b><span id="cardName"></span></div>
                        <div class="kv"><b>ƒ∞≈ü n√∂mr…ôsi</b><span id="cardCode"></span></div>
                        <div class="kv"><b>Sinif</b><span id="cardGrade"></span></div>
                        <div class="kv"><b>Otaq / Yer</b><span><span id="cardRoom"></span> ‚Ä¢ <span id="cardSeat"></span></span></div>
                        <div class="kv"><b>BSP t…ôl…ôb…ôsidir</b><span id="cardBsp"></span></div>
                        <div class="kv"><b>Saat</b><span id="cardExamTime"></span></div>
                        <div class="kv"><b>√únvan</b><span>Bakƒ±xanov q…ôs., Villa Plaza</span></div>
                    </div>

                    <div class="ticket-actions">
                        <button class="btn-secondary" onclick="printCard()">üñ®Ô∏è √áap et</button>
                    </div>
                </div>
            </div>

            <div class="empty-note" id="emptyNote">
                ...
            </div>
        </section>
    </div>
</main>

<!-- =========================
     CONFIRM MODAL (YENI)
     ========================= -->
<div id="confirmOverlay" class="overlay" style="display:none;">
    <div class="confirmModal">
        <h3>‚úÖ ∆èmins…ôn?</h3>
        <p style="margin-top:6px; color: rgba(71,85,105,.95); font-weight:700;">
            A≈üaƒüƒ±dakƒ± m…ôlumatlar d√ºzd√ºr?
        </p>

        <div class="confirmList" id="confirmList"></div>

        <div class="confirmActions">
            <button type="button" class="btnNo" onclick="closeConfirm(false)">‚ùå Yox</button>
            <button type="button" class="btnYes" onclick="closeConfirm(true)">‚úÖ H…ô, qeyd et</button>
        </div>
    </div>
</div>

<script>
    const EXAMS = {
        "6": { name: "Riyaziyyat buraxƒ±lƒ±≈ü sƒ±naq 5" },
        "7": { name: "Fizika m√∂vzu sƒ±naƒüƒ± 2" }
    };

    function hideResult(){
        const r = document.getElementById('result');
        r.className = '';
        r.style.display = 'none';
    }

    function showResult(type, text){
        const r = document.getElementById('result');
        document.getElementById('resultText').textContent = text;
        r.className = type;
        r.style.display = 'flex';
    }

    function updateSelectedExam() {
        const examId = document.getElementById("examSelect").value;
        const examName = EXAMS[examId]?.name || "ƒ∞mtahan";
        document.getElementById("cardExamName").textContent = examName;
    }

    function updateExamTime() {
        const grade = document.getElementById("gradeSelect").value;
        const examId = document.getElementById("examSelect").value;
        const examTimeSelect = document.getElementById("examTime");

        if (!grade || !examId) return;

        if (examId === "6") {
            if (grade === "9") examTimeSelect.value = "11:30";
            else if (grade === "10" || grade === "11") examTimeSelect.value = "10:00";
            else examTimeSelect.value = "10:00";
        } else if (examId === "7") {
            examTimeSelect.value = "11:30";
        }
    }

    function updatePaymentAmount() {
        const type = document.getElementById("studentType").value;
        const paymentInput = document.getElementById("paymentAmount");
        const bspCheckbox = document.getElementById("bspStudent");

        switch (type) {
            case "BSP":
                paymentInput.value = 0;
                bspCheckbox.checked = true;
                break;
            case "Other":
                paymentInput.value = 5;
                bspCheckbox.checked = false;
                break;
            default:
                paymentInput.value = "";
                bspCheckbox.checked = false;
        }
    }

    function formatDateAZ(d){
        const dd = String(d.getDate()).padStart(2,'0');
        const mm = String(d.getMonth()+1).padStart(2,'0');
        const yyyy = d.getFullYear();
        return `${dd}.${mm}.${yyyy}`;
    }

    /* =========================
       CONFIRM MODAL JS (YENI)
       ========================= */
    let confirmResolver = null;

    function openConfirm(summaryObj){
        const overlay = document.getElementById("confirmOverlay");
        const list = document.getElementById("confirmList");

        list.innerHTML = Object.entries(summaryObj).map(([k,v]) => `
        <div class="confirmItem">
          <span>${k}</span>
          <span>${v}</span>
        </div>
      `).join("");

        overlay.style.display = "flex";

        return new Promise((resolve) => {
            confirmResolver = resolve;
        });
    }

    function closeConfirm(answer){
        const overlay = document.getElementById("confirmOverlay");
        overlay.style.display = "none";
        if (confirmResolver) confirmResolver(answer);
        confirmResolver = null;
    }
</script>

<script>
    const form = document.getElementById('studentForm');
    const submitBtn = form.querySelector('button[type="submit"]');

    form.addEventListener('submit', async (e) => {
        e.preventDefault();

        updateSelectedExam();
        updateExamTime();

        submitBtn.disabled = true;
        const originalText = submitBtn.innerHTML;

        submitBtn.innerHTML = `
        <span style="display:inline-flex;align-items:center;gap:10px;justify-content:center;">
          <div style="border:3px solid rgba(255,255,255,.85);border-top:3px solid transparent;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;"></div>
          Y√ºkl…ônir...
        </span>`;

        const formData = Object.fromEntries(new FormData(e.target).entries());
        formData.bspStudent = document.getElementById('bspStudent').checked;
        formData.examId = parseInt(formData.examId, 10);
        formData.examTime = document.getElementById('examTime').value;

        const selectedExamId = String(formData.examId);
        document.getElementById('cardExamName').innerText = EXAMS[selectedExamId]?.name || "ƒ∞mtahan";

        const cardContainer = document.getElementById('cardContainer');
        const emptyNote = document.getElementById('emptyNote');

        /* =========================
           CONFIRM (YENI) - fetch-d…ôn …ôvv…ôl
           ========================= */
        const examName = EXAMS[String(document.getElementById("examSelect").value)]?.name || "ƒ∞mtahan";
        const summary = {
            "Ad Soyad Ata adƒ±": `${formData.name} ${formData.surname} ${formData.fatherName}`,
            "Sinif": formData.grade || "-",
            "F…ônn / ƒ∞mtahan": examName,
            "Saat": formData.examTime || "-"
        };

        const ok = await openConfirm(summary);
        if (!ok) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
            showResult("error", "Qeydiyyat l…ôƒüv edildi.");
            return;
        }

        try {
            const res = await fetch('/api/students/add', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(formData)
            });

            const data = await res.json();

            if (!res.ok) {
                const errorMessage = data.message || "G√∂zl…ônilm…ôz x…ôta ba≈ü verdi!";
                throw new Error(errorMessage);
            }

            const student = data;

            document.getElementById('cardExamTime').innerText = formData.examTime;
            document.getElementById('cardName').innerText = `${student.name} ${student.surname} ${student.fatherName}`;
            document.getElementById('cardGrade').innerText = student.grade;
            document.getElementById('cardCode').innerText = student.studentCode;
            document.getElementById('cardRoom').innerText = student.room.roomNo;
            document.getElementById('cardSeat').innerText = student.seatNo;

            document.getElementById('cardBsp').innerHTML = student.bspStudent
                ? "<span style='color:#065f46;font-weight:900;'>B…ôli ‚úÖ</span>"
                : "<span style='color:#991b1b;font-weight:900;'>Xeyr ‚ùå</span>";

            const now = new Date();
            document.getElementById('cardDate').innerText = formatDateAZ(now);
            document.getElementById('cardTime').innerText = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            cardContainer.style.display = 'block';
            emptyNote.style.display = 'none';
            showResult("success", "≈ûagird uƒüurla qeydiyyatdan ke√ßdi!");
        } catch (err) {
            showResult("error", err.message);
            cardContainer.style.display = 'none';
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });

    function printCard() {
        const examName = document.getElementById('cardExamName').textContent || "ƒ∞mtahan";
        const printWindow = window.open('', '_blank');

        const saleDate = document.getElementById('cardDate').textContent;
        const saleTime = document.getElementById('cardTime').textContent;

        printWindow.document.write(`
<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8">
  <title>${examName}</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    @page { margin: 0; size: A4; }
    * { box-sizing: border-box; }
    body { margin: 0; padding: 40px; display: flex; justify-content: center; font-family: 'Inter', sans-serif; background: #f6f8fa; }
    .ticket {
      width: 92%;
      background: #fff;
      border: 10px solid #22c55e;
      border-radius: 22px;
      display: flex;
      flex-direction: row;
      gap: 26px;
      padding: 26px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.08);
    }
    .left { width: 52%; }
    .left h2{ margin:0 0 12px; font-size: 20px; color: #064e3b; }
    .info p { margin: 6px 0; font-size: 15px; line-height: 1.7; }
    .right { width: 48%; display: flex; flex-direction: column; justify-content: space-between; }
    .social h3 { color: #f97316; margin-bottom: 10px; font-size: 16px; }
    .social p { margin: 4px 0; font-size: 14px; }
    .footer { text-align: center; font-weight: 700; color: #16a34a; border-top: 1px solid #e5e7eb; padding-top: 12px; font-size: 13px; }
    .qr { margin-bottom: 22px; text-align: center; }
    .qr img { width: 120px; height: 120px; border-radius: 12px; border: 2px solid #22c55e; }
    @media print { body { background: white; margin: 0; } .ticket { box-shadow: none; border: 1px solid #ccc; } }
  </style>
</head>
<body>
  <div class="ticket">
    <div class="left">
      <h2>${examName}</h2>
      <div class="info">
        <p><strong>Ad Soyad Ata adƒ±:</strong> ${document.getElementById('cardName').textContent}</p>
        <p><strong>ƒ∞≈ü n√∂mr…ôsi:</strong> ${document.getElementById('cardCode').textContent}</p>
        <p><strong>Sinif:</strong> ${document.getElementById('cardGrade').textContent}</p>
        <p><strong>Otaq:</strong> ${document.getElementById('cardRoom').textContent}</p>
        <p><strong>Yer:</strong> ${document.getElementById('cardSeat').textContent}</p>
        <p><strong>BSP LearnUp t…ôl…ôb…ôsidir:</strong> ${document.getElementById('cardBsp').textContent}</p>
        <p><strong>Tarix:</strong> 08.02.2026</p>
        <p><strong>Saat:</strong> ${document.getElementById('cardExamTime').textContent}</p>
        <p><strong>√únvan:</strong> Bakƒ±xanov q…ôs., Villa Plaza</p>
        <p>Biletin satƒ±≈ü tarixi: ${saleDate} | ${saleTime}</p>
      </div>
    </div>

    <div class="right">
      <div class="social">
        <h3>üì± Bizi izl…ôyin:</h3>
        <p>üé• YouTube: <b>Riyaziyyat h…ôr k…ôs √º√ß√ºn</b></p>
        <p>üì∏ ƒ∞nstagram: <b>math.bsp.az</b> | <b>bsplearnup</b></p>
        <p>üí¨ Telegram: <b>riyaziyyatherkesucun</b></p>
        <p>üåê Sayt: <b>mathbsp.az</b></p>
        <p>üìû ∆èlaq…ô: <b>070 621 12 29</b></p>
      </div>

      <div class="qr">
        <img src="mathbsp-az-qr-code.png" alt="QR Kod">
      </div>

      <p class="footer">üßÆ BSP LearnUp il…ô f…ôrq yarat!<br>‚Äú∆èziyy…ôt √ß…ôk, zirv…ôy…ô qalx!‚Äù</p>
    </div>
  </div>
</body>
</html>
      `);

        printWindow.document.close();
        setTimeout(() => printWindow.print(), 250);
    }
</script>
</body>
</html>
